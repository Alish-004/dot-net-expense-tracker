@page "/home"
@using coursework.Service
@inject UserService UserService

<PageTitle>Home</PageTitle>

<NavMenu></NavMenu>

<div class="container mt-4">
    <!-- Welcome Section -->
    <div class="text-center bg-light p-3 rounded shadow">
        <h2 class="display-5 text-primary">Welcome Back, Admin!</h2>
        <p class="lead">Track your spending, set your goals, and achieve financial freedom!</p>
    </div>

    <!-- Stats Overview -->
    <div class="row mt-3 g-3">
        <div class="col-6 col-md-3">
            <div class="card text-center bg-primary text-white shadow-sm">
                <div class="card-body">
                    <h6 class="card-title">Total Expenses</h6>
                    <p class="card-text h5">@currency @totalExpenses </p> <!-- Dynamically show total expenses -->
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center bg-success text-white shadow-sm">
                <div class="card-body">
                    <h6 class="card-title">Remaining Budget</h6>
                    <p class="card-text h5">@currency @remainingBalance</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center bg-info text-white shadow-sm">
                <div class="card-body">
                    <h6 class="card-title">Total Inflows</h6>
                    <p class="card-text h5">@totalInflows</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center bg-danger text-white shadow-sm">
                <div class="card-body">
                    <h6 class="card-title">Total Outflows</h6>
                    <p class="card-text h5">@totalOutflows</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3 g-3">
        <div class="col-6 col-md-3">
            <div class="card text-center bg-warning text-white shadow-sm">
                <div class="card-body">
                    <h6 class="card-title">Total Debts</h6>
                    <p class="card-text h5">@totalDebts</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add MudChart for Debts, Outflows, Inflows -->
    <MudPaper Class="pa-4 mt-4">
        <MudChart ChartType="ChartType.Donut" Width="300px" Height="300px" @bind-SelectedIndex="Index" InputData="@data" InputLabels="@labels"></MudChart>
    </MudPaper>

    <!-- Selected Portion Display -->
    <MudText Typo="Typo.h6">Selected portion of the chart: @Index</MudText>

    <!-- Financial Goals & Progress -->
    <div class="mt-4 p-3 bg-light rounded shadow-sm">
        <h3 class="text-center text-secondary">Your Financial Goal</h3>
        <p class="text-center">Goal: $500 savings this month</p>
        <div class="progress" style="height: 25px;">
            <div class="progress-bar bg-primary" style="width: 30%;">30%</div>
        </div>
        <p class="text-center mt-2">Progress: $150 saved</p>
    </div>

    <!-- Main Actions -->
    <div class="mt-4 text-center">
        <a href="/add-expense" class="btn btn-primary btn-lg mx-1 shadow-sm">Add Expense</a>
        <a href="/view-expenses" class="btn btn-secondary btn-lg mx-1 shadow-sm">View Expenses</a>
    </div>
</div>

<footer class="bg-primary text-white text-center py-2 mt-4">
    <p>&copy; 2025 Expense Tracker. All rights reserved.</p>
</footer>

@code {
    private int Index = -1; //default value cannot be 0 -> first selectedindex is 0.
    private int dataSize = 3; // Initial data size is 3 (Debts, Inflows, Outflows)
    public double[] data = { 500, 2000, 800 }; // Debts, Inflows, Outflows in this order
    public string[] labels = { "Debts", "Inflows", "Outflows" };

    Random random = new Random();

    private string currency;
    private string remainingBalance = "1500.00";
    private string totalInflows = "2000.00";
    private string totalOutflows = "800.00";
    private string totalDebts = "500.00"; // Added total debts property
    private string totalExpenses;

    void RandomizeData()
    {
        var new_data = new double[dataSize];
        for (int i = 0; i < new_data.Length; i++)
            new_data[i] = random.NextDouble() * 1000; // Randomize values
        data = new_data;
        StateHasChanged();
    }

    void AddDataSize()
    {
        if (dataSize < 20)
        {
            dataSize = dataSize + 1;
            RandomizeData();
        }
    }

    void RemoveDataSize()
    {
        if (dataSize > 0)
        {
            dataSize = dataSize - 1;
            RandomizeData();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Set initial data for the chart from service or defaults
        totalDebts = UserService.GetTotalNumberOfDebts().ToString("F2");
        totalOutflows = UserService.GetTotalNumberOfOutflows().ToString("F2");
        totalInflows = UserService.GetTotalNumberOfInflows().ToString("F2");
        remainingBalance = UserService.GetRemaingBalance().ToString("F2");
        totalExpenses = UserService.GetTotalExpenses().ToString();
        currency = UserService.GetCurrency();

        // Initialize the chart data and labels
        data = new double[] { Convert.ToDouble(totalDebts), Convert.ToDouble(totalInflows), Convert.ToDouble(totalOutflows) };
        labels = new string[] { "Debts", "Inflows", "Outflows" };
    }
}
